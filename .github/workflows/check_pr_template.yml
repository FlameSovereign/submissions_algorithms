name: Check if PR Template Is Complete

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check_template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install js-yaml

      - name: Check PR template
        id: check_template
        uses: actions/github-script@v6
        with:
          script: |
            const yaml = require('js-yaml');
            const prBody = context.payload.pull_request.body || '';
            
            // Normalize line endings
            const normalizedBody = prBody.replace(/\r\n/g, '\n');
            
            // Debug logging
            console.log('PR Body length:', normalizedBody.length);
            console.log('PR Body first 500 chars:', normalizedBody.substring(0, 500));
            console.log('PR Body contains ```yaml:', normalizedBody.includes('```yaml'));
            console.log('PR Body contains backticks:', normalizedBody.split('```').length - 1);
            
            // Find start and end indices
            const startMarker = '```yaml\n';
            const endMarker = '\n```';
            
            const startIndex = normalizedBody.indexOf(startMarker);
            if (startIndex === -1) {
              console.log('Could not find start marker');
              core.setFailed('Start marker not found');
              return;
            }
            
            const contentStart = startIndex + startMarker.length;
            const endIndex = normalizedBody.indexOf(endMarker, contentStart);
            if (endIndex === -1) {
              console.log('Could not find end marker');
              core.setFailed('End marker not found');
              return;
            }
            
            const yamlContent = normalizedBody.slice(contentStart, endIndex);
            console.log('Extracted YAML content:', yamlContent);
            
            let data;
            try {
              // Remove comments from YAML content
              const cleanYaml = yamlContent
                .split('\n')
                .map(line => line.split('#')[0].trim())
                .join('\n');
              
              console.log('Cleaned YAML content:', cleanYaml);
              data = yaml.load(cleanYaml);
              console.log('Parsed YAML data:', data);
            } catch (error) {
              console.log('YAML parsing error:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `:warning: Error parsing YAML: ${error.message}`
              });
              core.setFailed(`Invalid YAML: ${error.message}`);
              return;
            }
            
            const requiredFields = [
              'submission_name',
              'submission_folder',
              'authors',
              'affiliations',
              'ruleset',
              'framework',
              'description'
            ];
            
            const emptyFields = requiredFields.filter(field => {
              const value = data?.[field];
              return !value || 
                     value.toString().trim() === '' || 
                     value === '""' ||
                     value === '\"\"';
            });
            
            if (emptyFields.length > 0) {
              const emptyFieldsList = emptyFields
                .map(field => `  - ${field} is empty`)
                .join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `:warning: Please fill out all required fields in the PR template:\n\n${emptyFieldsList}`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['ðŸš§ Incomplete']
              });
              
              core.setFailed('Empty fields found');
              return;
            }
            
            // Remove incomplete label if present
            try {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              
              if (labels.some(label => label.name === 'ðŸš§ Incomplete')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: 'ðŸš§ Incomplete'
                });
              }
            } catch (error) {
              console.log('Error handling labels:', error);
            }
            
            core.setOutput('filled_out', 'true');
            core.setOutput('submission_data', data);